//DOTENV
require("dotenv").config;
//EXPRESS
const express = require("express");
//CORS
const cors = require("cors");
//BODYPARSER
const bodyParser = require("body-parser");
//MYSQL
const mysql = require("mysql");
//APP
const app = express();

//APP USES
app.use(cors());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

//DATOS DE CONEXION A LA BBDD
const {
  USE_PORT,
  MYSQL_HOST,
  MYSQL_USER,
  MYSQL_PASSWORD,
  MYSQL_DATABASE,
} = process.env;

const connection = mysql.createConnection({
  host: MYSQL_HOST, //HOST
  user: MYSQL_USER, //USUARIO
  password: MYSQL_PASSWORD, //CONTRASEÑA
  database: MYSQL_DATABASE, //BBDD QUE VOY A USAR
});

// CONEXION CON LA BBDD
connection.connect((error) => {
  if (error) throw error;
  console.log("DATABASE UP");
});

// PUERTO DE CONEXION DE LA API
const PORT = USE_PORT;

app.listen(PORT, () => console.log("API UP"));

//GET DE PRUEBA

app.get("/", (req, res) => {
  res.send("Te doy la bienvenida a mi API");
});

//RECOGIENDO TODAS LAS NOTAS

app.get("/notas", (req, res) => {
  //  SEQUENCIA SQL
  const sql = `SELECT * FROM lista_notas`;
  //CONEXIÓN Y EJECUCION DEL SQL
  connection.query(sql, (error, results) => {
    // SI HAY ERROR, QUE LO MUESTRE
    if (error) throw error;
    //COMPROBAR QUE LA RESPUESTA NO VIENE VACIA
    if (results.length > 0) {
      res.json(results);
    }
    //EN CASO DE QUE VENGA VACIA
    else {
      res.send("Lista de notas no encontrada");
    }
  });
});

// ACTUALIZANDO UNA NOTA

app.put("/notas/update/:id", (req, res) => {
  //Texto e id que nos llegan del formulario

  const { texto, id } = req.body;
  /*   const texto = req.body.texto;
  const id = req.body.id; */
  // Secuencia SQL
  const sql = `UPDATE lista_notas SET texto='${texto}' WHERE id=${id}`;
  connection.query(sql, (error) => {
    if (error) throw error;
    res.send("Nota actualizada");
  });
});

//BORRANDO UNA NOTA

app.delete("/notas/del/:id", (req, res) => {
  res.send("Mi nota x ha sido borrada :(");
});

//AÑANDIENDO UNA NOTA

app.post("/notas/add", (req, res) => {
  //sequencia SQL
  const sql = `INSERT INTO lista_notas SET ?`;
  // Objeto que recibe la BBDD
  const newNote = {
    texto: req.body.texto,
  };
  //CONEXION Y EJECUCION DE SQL
  connection.query(sql, newNote, (error) => {
    if (error) throw error;
    res.send("Nota creada");
  });
});
